<!DOCTYPE html>
<html lang="en">
<!-- 
Copyright (c) Pete Werner, 2016
-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="CS:GO Pistol Damage. Explore relative pistol damage under various conditions, for the pistols in the CS:GO world.">
    <meta name="author" content="Pete Werner">

    <title>CS:GO Pistol Damage</title>

    <!-- Bootstrap core CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="bs/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="bs/starter-template.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="bs/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="bs/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-72802092-1', 'auto');
  ga('send', 'pageview');

</script>
<script src="d3.js"></script>
<script type="text/javascript" src="force_labels.js"></script>
<style>
.link { stroke:gray;stroke-width:0.35}
.plottext {text-anchor:middle;font-size:16px;font-family: sans-serif}
.plotlabel {text-anchor:middle;font-size:20px;font-family: sans-serif}
.axis path,
.axis line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges;
}

.axis text {
    font-family: sans-serif;
    font-size: 11px;
}

</style>

  </head>

  <body>
<script>

var width = 750;
var height = 550;
var inner_spc = 65;
var marg_top = 50;
var marg_bot = 50;
var marg_left = 50;

var svg;
var xscale, yscale;
var xmax, ymax;
var all_data;
var points;
var labels;

var xax, yax;

function redrawLabels() {
    labelBox
        .attr("transform",function(d) { 
		return "translate("+ (d.labelPos.x) +" "+d.labelPos.y+")"})

    plinks
        .attr("x1",function(d) { return d.anchorPos.x})
        .attr("y1",function(d) { return d.anchorPos.y})
        .attr("x2",function(d) { return d.labelPos.x})
        .attr("y2",function(d) { return d.labelPos.y})
}


labelForce = d3.force_labels()
    .size([width, height])
    .linkDistance(10.0)
    .gravity(0.0)
    .nodes([]).links([])
    .charge(-200)
    .on("tick",redrawLabels)


var setaxis = function(d)
{
	fix_x = d3.select('input[name="fixx"]').node().checked;
	if (fix_x) {
		xmax = 1.0;
		xmin = 0.0;
	} else {
		xmax = d3.max(d, function(d) { return d.xval;});
		xmin = d3.min(d, function(d) { return d.xval;});
	}

	fix_y = d3.select('input[name="fixy"]').node().checked;
	if (fix_y) {
		var per = d3.select('input[name="per"]:checked').node().value;
		if (per == 't') 
			ymax = d3.max(all_data, function(f) { return d3.max(f.data, function(g) { return g.dpt_u }) })
		else
			ymax = d3.max(all_data, function(f) { return d3.max(f.data, function(g) { return g.dpc_u }) })
		ymin = 0;
	} else {
	        ymax = d3.max(d, function(d) { return d.val });
        	ymin = d3.min(d, function(d) { return d.val ;});
	}


	var x0 = marg_left + inner_spc;
	var x1 = x0 + width - inner_spc; //pad to the right by inner_spc as well

        xscale = d3.scale.linear().domain([xmin, xmax]).range([x0, x1]);
	
	x_left = xscale.invert(marg_left);
	x_right = xscale.invert(marg_left + width + inner_spc);
        xscale2 = d3.scale.linear().domain([x_left, x_right]).range([0, width + inner_spc]);
	
	var y0 = marg_top + inner_spc;
	var y1 = marg_top + height - inner_spc; 
        yscale = d3.scale.linear().domain([ymin, ymax]).range([y1, y0]);
	yt = marg_top;
	yb = height + inner_spc;
	y_top = yscale.invert(yt);
	y_bot = yscale.invert(yb);
	yscale2 = d3.scale.linear().domain([y_bot, y_top]).range([yb, yt]);
	
	xax = d3.svg.axis().scale(xscale2).orient('bottom');
	yax = d3.svg.axis().scale(yscale2).orient('left');
}


var circleDraw = function(d) 
{
	this.attr("cx", function(d) { return xscale(d.xval); })
	.attr("cy", function(d) { return yscale(d.val); })
	.attr("x_val", function(d) { return d.xval })
	.attr("y_val", function(d) { return d.val })
	.attr("fill", function(d) { return 'rgb('+ Math.floor(255 * d.val/ymax) +',20,'+ Math.floor(255 * (1-d.val/ymax)) +')';})
	.attr("r", function(d) { return 1 + 15 * d.xval/xmax });
}

var textDraw = function(d)
{
	this.text(function(d) { return d.label; });
}

var selectData = function(d)
{
	var range = d3.select('input[name="range"]:checked').node().value;
	var run = d3.select('input[name="run"]:checked').node().value == 'true';
	var tap = d3.select('input[name="tap"]:checked').node().value == 'true';
	var arm = d3.select('input[name="arm"]:checked').node().value;
	var per = d3.select('input[name="per"]:checked').node().value;
	//var ev = d3.select('input[name="ev"]:checked').node().value == 'ev';
	var inacc = !d3.select('input[name="inacc"]').node().checked
	var pen_mag = d3.select('input[name="pen_mag"]').node().checked
	//var pen_mag_amt = d3.select('input[name="pen_mag_amt"]').node().value;
	var pen_ammo = d3.select('input[name="pen_ammo"]').node().checked;
	//var pen_ammo_amt = d3.select('input[name="pen_ammo_amt"]').node().value;

	field = 'd';
	field += per == 't' ? 'pt' : 'pc';
	field += arm == 'a' ? '_a' : '_u';

	//console.log('run: ' + run + ', tap: ' + tap + ', range: ' + range);
	var sel = d.filter(function(e) {
		if (e.run == run && e.tap == tap && e.range == range)
			return true;
		return false;
	}); 
	if (sel.length != 1)
		console.log('got sel of len ' + sel.length)
	
	var tmp = sel[0].data.map(function(d) {
		var k = { 'label' : d.weap}
		k.val = d[field];
		k.val *= inacc ? d.hit : 1.0;
		//k.val -= k.val * pen_mag_amt * (1 - d.mag_pen);
		//k.val -= k.val * pen_ammo_amt * (1 - d.ammo_pen);
		//0.5 is an arbitrary choice
		k.val *= pen_mag ? (0.5 * d.mag_pen) : 1.0;
		k.val *= pen_ammo ? (0.5 * d.ammo_pen) : 1.0;
		k['xval'] = d.hit;
		return k;
	});
	return tmp;
}

var chplt = function(d)
{
	var t = 1000;
	setaxis(d);
	points = svg.selectAll('.anchor').data(d)
	points.call(labelForce.update);
	points.transition().duration(t).call(circleDraw);
	svg.selectAll('#xaxis').transition().duration(t).call(xax);
	svg.selectAll('#yaxis').transition().duration(t).call(yax);
}

var drawPlot = function(d)
{
	setaxis(d);

	svg.append('g').attr('class', 'axis').attr('id', 'xaxis')
		.attr('transform', 'translate(' + marg_left + ', ' + (height + inner_spc) +')' ).call(xax);
	svg.append('g').attr('class', 'axis').attr('id', 'yaxis')
		.attr('transform', 'translate(' + marg_left + ',0)' ).call(yax);

	points = svg.selectAll('.anchor').data(d).enter().append('circle').attr('class', 'anchor').call(circleDraw);
	labels = svg.selectAll('.labels').data(d).enter().append('g').attr('class', 'labels');
	plinks = labels.append('line').attr('class', 'link')
	labelBox = labels.append('text').attr('class', 'plottext').call(textDraw);
	points.call(labelForce.update);

	svg.append('text').attr('x', (width + marg_left + inner_spc) /2.0)
		.attr('y', height + marg_bot + marg_top + inner_spc * 0.5 )
		.attr('class', 'plotlabel')
		.text('Accuracy')
}


var doit = function(error, full_dataset) {
	dataset = full_dataset[0];
	svg = d3.select("#main")
		.attr("width", width + marg_left + inner_spc)
		.attr("height", height + marg_bot + marg_top + inner_spc);
	all_data = full_dataset;
	var d = selectData(all_data);
	drawPlot(d);
}

var formup = function()
{
	var d = selectData(all_data);
	chplt(d);
}

d3.json("data.json", doit); 

</script>


    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">CS:GO Pistol Damage</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
		<!--
            <li class="active"><a href="#">Pistols</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
		-->
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

<div class="container">

<div class="starter-template">
<h1>CS:GO Pistol Damage</h1>
Explore relative pistol damage under various conditions, for the pistols in the CS:GO world.
</div>

<div>

<form id='ctlform' onclick="formup()">
<label class='radio-inline'>
<input type='radio' name='range' value='short'>Short Range</input>
</label>
<label class='radio-inline'>
<input type='radio' name='range' value='medium' checked='true'>Medium Range</input>
</label>
<label class='radio-inline'>
<input type='radio' name='range' value='long'>Long Range</input>
</label>
<br />
<label class='radio-inline'>
<input type='radio' name='arm' value='a' checked='true'>Armoured</input>
</label>
<label class='radio-inline'>
<input type='radio' name='arm' value='u'>Unarmoured</input>
</label>
<br />
<label class='radio-inline'>
<input type='radio' name='run' value='true' checked='true'>Running</input>
</label>
<label class='radio-inline'>
<input type='radio' name='run' value='false'>Standing</input>
</label>
<br />
<label class='radio-inline'>
<input type='radio' name='tap' value='true'>Tap Shoot</input>
</label>
<label class='radio-inline'>
<input type='radio' name='tap' value='false' checked='true'>Spam</input>
</label>
<br />
<!--
<input type='radio' name='ev' value='ev' checked='true'>Accuracy</input>
<input type='radio' name='ev' value='raw' >Ignore Accuracy</input>
-->
<label class='checkbox-inline'>
<input type='checkbox' name='inacc' >Ignore Accuracy</input>
</label>
<br />
<label class='radio-inline'>
<input type='radio' name='per' value='t' checked='true'>Damage/Time</input>
</label>
<label class='radio-inline'>
<input type='radio' name='per' value='c'>Damage/Weapon Cost</input>
</label>
<br />
<label class='checkbox-inline'>
<input type='checkbox' name='pen_mag'>Penalize smaller mags</input>
</label>
<label class='checkbox-inline'>
<input type='checkbox' name='pen_ammo'>Penalize less ammo overall</input>
</label>
<!--
<br />
Mag Size Penalty: <input type='range' name='pen_mag_amt' min="0.0" max="1.0" value="0.0" step="0.01"/>
<br />
Total Ammo Penalty: <input type='range' name='pen_ammo_amt' min="0.0" max="1.0" value="0.0" step="0.01"/>
-->
<br />
<label class='checkbox-inline'>
<input type='checkbox' name='fixx'>Fix accuracy axis</input>
</label>
<label class='checkbox-inline'>
<input type='checkbox' name='fixy'>Fix damage axis</input>
</label>

</form>

<svg id='main'></svg>

<p>
Notes:
<p>
<div id='notes'>
<small>
Short Range: 1 - 500 units. <br />
Medium Range: 501 - 1000 units. <br />
Long Range: 1001 - 1500 units. <br />
Armoured/Unarmoured: Opponents armour status. <br />
Running: Movement speed is weapon maximum. <br />
Standing: Movement speed is 0. <br />
Tap Shooting: Pause between each shot (effectively ignores firing inaccuracy). <br />
Spam: Fire as fast as possible. <br />
Ignore Inaccuracy: Show raw damage values, ignoring probability of hitting the target. <br />
Damage/Time: Y axis scale is amount of damage as a function of time (i.e. amount of time required to fire 10,000 rounds). <br />
Damage/Weapon Cost: Y axis scale is damage as a function of weapon cost. <br />
Penalize smaller mags: Damage amount is penalized by smaller magazine size. <br />
Penalize less ammo overall: Damage amount is penalized for weapons that have less ammo overall. <br />
n.b. dualies have the most ammo, so the above two all relative to them.<br />
Fix accuracy axis: Use a constant scale for the x-axis, making it easier to compare across different variables. <br />
Fix damage axis: Use a constant scale for the y-axis. <br />
</small>

</div>

<div id='discussion'>
<h2>Accuracy Calculation</h2>
<p>
This is the probability of hitting a circular target of radius 6 units (12 units diameter), across the various ranges, and under the various conditions. In game, 1 unit = 1 inch, so 12 units is 1ft/roughly a 30cm circle. 
</p>
<p>
In the plot, less accurate weapons have smaller circles while more accurate weapons have bigger ones. The x-axis represents accuracy. If you want to compare across ranges, enable the "Fix accuracy axis" option. 
</p>
<p>
Accuracy has been determined by collecting 10,000 sample pistol shots from a simulation of the CS:GO shoot mechanics I developed in python. Most of the raw mechanics information came from a document by reddit user Altimor, which detailed the various formulas and how they are applied.  
</p>
<p>
The source code of CS:GO is not available, so some liberties have to be taken. I can't be 100% confident the data is a true reflection of actual game mechanics, but at the least, any bias or innacuracy present would be applied to each weapon equally, which should enable reasonable relative comparisions.
</p>
<p>
The only missing thing I am aware of is weapon reload time, as I don't have accurate data. I don't think it really matters so much as you generally don't reload in the middle of firefights.
</p>
<p>
I also do not model recoil, it effectively assumes perfect recoil control while spamming, but the model does include the inherent randomness applied to all shots fired. 
</p>

<h2>Damage</h2>
<p>
The default y-axis shows damage as a function of time. Weapons delivering more damage are redder in color, while weapons doing less damage are bluer in color. 
</p>
<p>
The actual damage values aren't particularly interpretable, the goal of the plot is to show a relative comparison of all the pistols under different circumstances. Weapons that are close perform similarly, weapons far away have large differences. 
</p>
<p>The data is the average for each pistol over 10,000 shots, and firing times vary considerably. The quickest is the CZ at 100ms (the same rate as the AK-47 rifle), and the longest is the revolver at 500ms. Displaying damage per time is convenient way of controlling for different firing speeds.
</p>
<p>
You can also use damage per the in-game weapon cost. All the pistols are relatively cheap, and I dont feel its particularly accurate measure but was easy to add so threw it in there.
</p>
<p>
When "Ingore Inaccuracy" is left un-checked, the damage values are multipled by the probability of landing a shot (i.e. accuracy), giving some measure of the expected value of each pistol under the other conditions (range, shooting mode etc)
</p> 

<h2>Comments</h2>
<p>In general, I think what these plots show are inline with the accepted meta. Which pleases me, as it means I probably havent stuffed up majorly along the way. 
<p>
The dualies (elite) are very strong against unarmoured opponents. They fire very quickly and have a lot of ammo, good for running & gunning. Tec9 is the best against armoured opponents, even considering magazine sizes.
<p>
The revolver packs a hell of a lot of punch, which tends to override most other factors. The deagle has a large movement penalty, but when standing and tap shooting it performs in-line with the revolver. 

<h2>Unsolved Mysteries</h2>
<p>
There's a couple of things I am still not sure about, or don't really make sense. If you know the answers please get in touch.
</p>
<p>
First is how the reported weapon accuracy ranges are derived.
<p>
Lets say I fire the AK-47 standing still, which gives 6.41 + 0.6 = 7.01 mm inaccuracy. 
<p>
If i go in-game and turn on cl_weapon_debug_print_accuracy, it says its accurate range is 30.7m to guaranteed hit a 30cm target. 
<p>
It is not clear to me how the game gets from inaccuracy (spread + standing + firing + moving) to that distance.
<p>
I thought that perhaps that is the inaccuracy radius, so 2x would be the diameter of the inaccuracy circle, and to hit a 30cm (0.3m) plate we would have to be within:
<p>
0.3 / (2 * 0.00701) = max accurate distance = 21.4m
</p>
<p>
If we flip it round, we know the base inaccuracy is 7.01 and effective range is 30.7m, so the game is using
2 * 0.00701 * 30.7 = 0.4304 m target, or 43 cm and roughly 17 units, a lot bigger than 30cm.
If you skip the 2x part it gives 0.2152 m, which is still a long way from 30cm really.
</p>
<p>
The second mystery is in the display for debug_print_accuracy, the value of SpreadDistance seems to be (Inaccuracy + Spread) * 320. I don't know where that 320 value comes from. 
</p>
<h2>Contact</h2>
<p>
You can find me on twitter <a href="https://twitter.com/dizzy_pete">here</a>
<p>
You can email me pete dot werner at gmail 
<p>
Thanks for reading!
</div>

</div>


</div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="bs/jquery.min.js"><\/script>')</script>
    <script src="bs/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="bs/ie10-viewport-bug-workaround.js"></script>
  </body>
</html>
